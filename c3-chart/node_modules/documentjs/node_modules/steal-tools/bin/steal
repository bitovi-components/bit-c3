#!/usr/bin/env node
var winston = require('winston');
var path = require("path");
var yargs = require("yargs")
	.usage("Usage: $0 [build|transform] --main app --config path/to/stealconfig.js")
	.demand(["config", "main"])
	.describe("config", "Path to the config file")
	.describe("main", "The application's entry point module")
	.describe("bundles-path", "Defaults to dist/bundles, a directory to save the bundles")
	.describe("bundle-steal", "Include steal.js in your main bundled JavaScript")
	.describe("ignore", "For transform, a comma-separated list of modules to not include in the output")
	.describe("out", "For transform, specify an output file")
	.describe("verbose", "Verbose output")
	.describe("quiet", "Quiet output")
	.version(require("../package.json").version, "version")
	.check(function(argv){
		var command = argv._[0];

		if(!command) {
			throw "Must provide a command to execute";
		}

		if(command !== "build" && command !== "transform") {
			throw "Unknown command: " + command;
		}

		if(command === "transform" && !argv.out) {
			throw "When using transform, must specify an out file";
		}

	});

// The command-line arguments
var argv = yargs.argv;

// Determine the location of the config file
var config = argv.config[0] === "/" ?
	argv.config : path.join(process.cwd(), argv.config);


// Which command to run, either `build` or `transform`
var command = argv._[0];

// Load steal-tools
var stealTools = require("../index");

if(command === "build"){

	return build();

} else if(command === "transform") {

	return transform();

}

function build() {

	stealTools.build({
		config: config,
		main: argv.main
	}, {
		verbose: argv.verbose,
		quiet: argv.quiet,
		bundleSteal: argv.bundleSteal,
		bundlesPath: argv.bundlesPath
	}).then(function(){
		winston.info('\nBuild completed successfully'.green);
	});

}

function transform() {
	var fs = require("fs");
	var ignore = [];

	// ignore would be a comma-separated list like jquery,underscore,moment
	if(argv.ignore) {
		ignore = argv.ignore.split(",");
	}

	stealTools.transform({
		config: config,
		main: argv.main
	}, {
		verbose: argv.verbose,
		quiet: argv.quiet
	}).then(function(transform){

		var content = transform(null, {
			ignore: ignore
		});

		// Write out the contents
		fs.writeFileSync(argv.out, content, "utf8");
	});

}
